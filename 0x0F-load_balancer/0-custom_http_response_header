#!/usr/bin/env bash

# This script configures Nginx on a new Ubuntu machine to:
#   - Listen on port 80
#   - Serve "Hello World" at the root path
#   - Redirect /redirect_me to cuberule.com (301 Moved Permanently)
#   - Serve a custom 404 page ("Ceci n'est pas une page")
#   - Include a custom header (X-Served-By) with the server's hostname

# Update package lists
apt-get update

# Install Nginx with the 'y' flag to accept prompts automatically
apt-get install -y nginx

# Create the directory structure for website content (/var/www/html)
mkdir -p /var/www/html

# Create a basic index.html file with "Hello World" content
touch /var/www/html/index.html
echo "Hello World" > /var/www/html/index.html

# Create a custom 404.html file with the message "Ceci n'est pas une page"
touch /var/www/html/404.html
echo "Ceci n'est pas une page" > /var/www/html/404.html

# Build the complete Nginx server block configuration using printf
printf %s "
server {
  listen 80 default_server;  # Listen on port 80 (default web port)
  listen [::]:80 default_server;  # Also listen on IPv6

  # Add a custom header named X-Served-By with the server's hostname
  add_header X-Served-By $HOSTNAME;

  root /var/www/html;  # Set the root directory for website content

  # Define default index files (index.html or index.htm)
  index index.html index.htm;

  # Location block for redirecting /redirect_me to cuberule.com (301)
  location /redirect_me {
    return 301 http://cuberule.com/;
  }

  # Handle 404 errors (page not found)
  error_page 404 /404.html;

  # Location block to serve the custom 404 error page internally
  location /404 {
    root /var/www/html;
    internal;
  }
}
" > /etc/nginx/sites-available/default

# Restart Nginx service to apply the new configuration
service nginx restart
